# AI 토큰 사용량 모니터링 맥 앱 조사/계획

## 전제/제약
- 네트워크 접근 없이 작성한 1차 조사 초안입니다. 구체 커맨드/파일 위치는 실제 환경에서 확인이 필요합니다.
- 목표: 로컬에서 사용량을 집계해 맥 상단(메뉴바)에서 확인.

## 1) 토큰 사용량 모니터링 수단 조사
### A. Claude Code 사용량
- 확인 결과
  - Claude Pro 사용량은 "세션 기반"이며 5시간마다 리셋됨(Help Center 명시).
- 개선 포인트
  - 폴링 주기(예: 60초)로 최신값 유지.
- 리셋 시점(카운트다운) 산출 방법
  - **ccusage 기반 시간 계산은 제외**.
  - 정확한 리셋 시각은 `/status`의 Usage 탭에서 확인되는 “Resets … (Asia/Seoul)” 문구 파싱.
  - `/status`는 인터랙티브 명령이므로 PTY 기반 자동 입력 필요.

## 1-추가) /status 자동 획득 가능성
- /status는 Claude Code 인터랙티브 세션의 슬래시 명령.
- `claude -p "/status"`는 동작하지 않음(Unknown slash command).
- PTY 기반 자동 입력으로 사용 가능:
  - `/status` 실행 → tab 2회로 Usage 탭 이동 → “Resets … (Asia/Seoul)” 파싱.
  - 구현: `capture-status.py` (PTY로 `claude` 실행 후 키 입력 자동화).
- 스크립트: `check-claude-usage.sh` (요약 출력)

### B. 일반적 토큰 집계 대안
- API 호출 가로채기/래핑
  - 앱이 직접 API를 호출하는 구조라면, 요청/응답의 토큰 메타데이터를 로그로 저장.
  - 장점: 정확도 높음. 단점: 기존 CLI/앱을 그대로 쓰는 경우 적용 어려움.
- 로컬 프록시
  - 로컬 프록시로 API 요청을 통과시켜 사용량 집계.
  - 장점: 범용성. 단점: 설정 복잡도, 인증/보안 고려 필요.
- 로그 기반 집계
  - CLI/앱이 남기는 로그를 파싱.
  - 장점: 구현 간단. 단점: 로그 형식 변경에 취약.

## 2) 맥 상단(메뉴바) 앱 구현 방법 조사
### A. 기술 스택 옵션
- Swift + SwiftUI + AppKit(NSStatusItem)
  - 메뉴바 아이콘, 드롭다운 패널 구현에 표준적.
  - 백그라운드 타이머/작업 스케줄링 구현 용이.
- Electron/Node 기반
  - 빠른 크로스플랫폼 구현 가능.
  - 메뉴바 전용 앱 UX/메모리 측면에서 다소 무거울 수 있음.
- Swift + Menubar-only App (Agent)
  - Dock 아이콘 숨기기(LSUIElement)로 순수 메뉴바 앱 가능.

### B. UI/UX 구성 아이디어
- 메뉴바 표시: `사용량/한도` 또는 `오늘 사용량` 등 한 줄 요약.
- 클릭 시: 상세 모델별 사용량, 리셋 시점, 최근 호출 리스트(옵션).
- 상태 업데이트: 폴링 주기/수동 새로고침 버튼 제공.

### C. 수집 방식과 앱 구조
- 수집 모듈(Collector)
  - `ccusage` 실행 → 출력 파싱 → 로컬 저장(SQLite/JSON).
  - 실패 시 마지막 성공값 유지 + 경고 상태 표시.
- 스케줄러
  - 앱 내 타이머(단순) 또는 `launchd` 사용(장시간 백그라운드 안정성).
- 데이터 저장
  - 간단하면 JSON/SQLite로 로컬 저장.
  - 일/주/월 단위 통계가 필요하면 SQLite 권장.

## 3) 단계별 구현 계획(문서)
### 1단계: 실제 데이터 소스 확정
- `ccusage` 출력 형식, `/status` 정보, 가능하면 로컬 로그 위치 확인.
- 필요한 필드 정의: 총 토큰, 입력/출력 분리, 리셋 시점, 모델별 분리 여부.
- 성공 기준: 터미널에서 최소 1회 안정적으로 파싱 가능한 출력 확보.

### 2단계: 데이터 수집기(Collector) 프로토타입
- 커맨드 실행/파싱/에러 처리 루틴 작성.
- 최소 스키마 정의(예: timestamp, total, in, out, model).
- 성공 기준: 로컬에 24시간치 샘플 누적 가능.

### 3단계: 메뉴바 앱(MVP)
- NSStatusItem으로 메뉴바 표시.
- 주기적 업데이트(예: 60초)와 수동 새로고침 버튼.
- 성공 기준: 메뉴바에 최신 사용량이 노출되고, 클릭 시 상세 팝오버 표시.

### 4단계: 안정화/운영
- 실패/지연 시 상태 아이콘 변경(예: 물음표).
- 로그 로테이션/보관 주기 설정.
- `launchd` 등록 여부 결정(재부팅 후 자동 실행).

### 5단계: 고도화(선택)
- 기간별 통계(일/주/월).
- 알림(사용량 임계치 도달 시).
- 다중 계정/프로파일 지원.
